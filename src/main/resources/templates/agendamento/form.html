<!DOCTYPE html>
<html lang="pt-BR" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${isEdit ? 'Editar Agendamento' : 'Novo Agendamento'} + ' - Sistema de Terminais'"></title>
    <link th:href="@{/css/bootstrap.min.css}" rel="stylesheet">
    <link th:href="@{/css/all.min.css}" rel="stylesheet">
    <link th:href="@{/css/style.css}" rel="stylesheet">
    <link rel="icon" type="image/x-icon" th:href="@{/favicon.ico?v=1}" />
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container"><a class="navbar-brand" th:href="@{/home}"><i class="fas fa-desktop"></i> Sistema de
        Terminais Atacadão</a>
        <div class="navbar-nav ms-auto"><a class="nav-link" th:href="@{/logout}"><i class="fas fa-sign-out-alt"></i>
            Sair</a></div>
    </div>
</nav>
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4"><h2><i class="fas fa-calendar text-secondary"></i><span class="text-secondary"
            th:text="${isEdit ? 'Editar Agendamento' : 'Novo Agendamento'}"></span></h2>            <a
            th:href="@{/agendamentos}" class="btn btn-secondary"> <i class="fas fa-arrow-left"></i> Voltar </a></div>
    <div class="card">
        <div class="card-body">
            <!-- Mensagem de erro -->
            <div th:if="${erro}" class="alert alert-danger" role="alert"
                 th:utext="${#strings.replace(erro, '\n', '<br/>')}">
            </div>
            <form th:action="@{/agendamentos/salvar}" th:object="${agendamentoRequest}" method="post"
                  class="needs-validation" novalidate id="frmAgendamento"><input th:if="${isEdit}" type="hidden" th:field="*{id}">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <input type="hidden" id="usuario" th:value="${usuario_sist}"/>
                            <label for="titulo" class="form-label">Título *</label>
                            <input type="text"
                                         class="form-control"
                                         th:field="*{titulo}"
                                         th:classappend="${#fields.hasErrors('titulo')} ? 'is-invalid' : ''"
                                         placeholder="Ex: Demonstração de produtos"
                                         required
                                         maxlength="100">
                            <div class="invalid-feedback" th:if="${#fields.hasErrors('titulo')}"
                                 th:errors="*{titulo}"></div>
                        </div>
                    </div>
                    <div class="mb-3"><label for="descricao" class="form-label">Descrição</label> <textarea
                            class="form-control" rows="1" th:field="*{descricao}"
                            th:classappend="${#fields.hasErrors('descricao')} ? 'is-invalid' : ''"
                            placeholder="Descrição detalhada do agendamento" maxlength="500"></textarea>
                        <div class="invalid-feedback" th:if="${#fields.hasErrors('descricao')}"
                             th:errors="*{descricao}"></div>
                        <div class="form-text">Máximo 500 caracteres</div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Conteúdo</label>
                            <select class="form-select form-control" id="conteudoSelect" name="conteudoSelect">
                            <option value="">Selecione um Conteúdo</option>
                            <option th:each="conteudo : ${conteudos}" th:value="${conteudo.id}"
                                    th:selected="${isEdit && agendamentoRequest.terminalConteudo.conteudo.id == conteudo.id}"
                                    th:text="${conteudo.titulo + ' - ' + conteudo.descricao}"></option>
                        </select></div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Terminal</label> <select
                                class="form-select form-control" id="terminalSelect" name="terminalSelect">
                            <option value="">Selecione um terminal</option>
                            <option th:each="terminal : ${terminais}" th:value="${terminal.id}"
                                    th:selected="${isEdit && agendamentoRequest.terminalConteudo.terminal.id == terminal.id}"
                                    th:text="${terminal.nome + ' - ' + terminal.localizacao}"></option>
                        </select></div>
                    </div>
                </div>
                <div class="row">
                    <label class="form-label">Deixando as duas datas em branco inclui agendamento para agora.
                        Deixando somente a data fim, terá o início escolhido sem final</label>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="dataInicio" class="form-label">Data/Hora Início *</label>
                            <input
                                type="datetime-local" class="form-control" th:field="*{dataInicio}"
                                th:classappend="${#fields.hasErrors('dataInicio')} ? 'is-invalid' : ''"
                                required id="dataInicio">
                            <div class="invalid-feedback" th:if="${#fields.hasErrors('dataInicio')}"
                                 th:errors="*{dataInicio}"></div>
                            <div class="form-text">Horário de funcionamento: 7h às 22h</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3"><label for="dataFim" class="form-label">Data/Hora Fim *</label>
                            <input
                                type="datetime-local" class="form-control" th:field="*{dataFim}"
                                th:classappend="${#fields.hasErrors('dataFim')} ? 'is-invalid' : ''"
                                required id="dataFim">
                            <div class="invalid-feedback" th:if="${#fields.hasErrors('dataFim')}"
                                 th:errors="*{dataFim}"></div>
                            <div class="form-text">Máximo 8 horas por agendamento</div>
                        </div>
                    </div>
                </div>
                <!-- Alert para conflitos -->
                <div id="conflito-alert" class="alert alert-warning" style="display: none;"><i
                        class="fas fa-exclamation-triangle me-2"></i> <span id="conflito-message"></span></div>
                <div class="d-grid gap-2 d-md-flex justify-content-md-end"><a th:href="@{/agendamentos}"
                                                                              class="btn btn-secondary me-md-2">Cancelar</a>
                    <button type="button" id="btn-salvar" class="btn btn-primary"><i class="fas fa-save"></i> <span
                            th:text="${isEdit ? 'Atualizar' : 'Salvar'}"></span></button>

                </div>
            </form>
        </div>
    </div>
</div>
<script th:src="@{/js/bootstrap.bundle.min.js}"></script>
<script th:src="@{/js/app.js}"></script>
<script>
    // Script para verificação de conflitos em tempo real
    let timeoutId;

    function verificarConflito() {
        const terminalId = document.getElementById('terminalSelect').value;
        const dataInicio = document.getElementById('dataInicio').value;
        const dataFim = document.getElementById('dataFim').value;
        const agendamentoId = /*[[${isEdit ? agendamentoRequest.id : null}]]*/ null;
        if (!terminalId || !dataInicio || !dataFim) {
            esconderAlertConflito();
            return;
        }
        // Debounce para evitar muitas requisições
        clearTimeout(timeoutId);
        timeoutId = setTimeout(() => {
            console.log("entrou")
            fetch(`/agendamentos/api/verificar-conflito?terminalId=${terminalId}&dataInicio=${dataInicio}&dataFim=${dataFim}&agendamentoId=${agendamentoId || ''}`).then(response => response.text()).then(result => {
                console.log(result)
                if (result === 'CONFLITO') {
                    mostrarAlertConflito('Existe conflito de horário para este terminal neste período');
                } else if (result === 'OK') {
                    esconderAlertConflito();
                } else if (result.startsWith('ERRO')) {
                    mostrarAlertConflito('Erro ao verificar conflito: ' + result.substring(6));
                }
            }).catch(error => {
                console.error('Erro ao verificar conflito:', error);
            });
        }, 500);
    }

    function mostrarAlertConflito(mensagem) {
        const alert = document.getElementById('conflito-alert');
        const message = document.getElementById('conflito-message');
        const btnSalvar = document.getElementById('btn-salvar');
        message.textContent = mensagem;
        alert.style.display = 'block';
        btnSalvar.disabled = true;
    }

    function esconderAlertConflito() {
        const alert = document.getElementById('conflito-alert');
        const btnSalvar = document.getElementById('btn-salvar');
        alert.style.display = 'none';
        btnSalvar.disabled = false;
    }

    // Script específico para preview da URL
    function consisteCampos() {
        const conteudoSelect = document.getElementById('conteudoSelect');
        const conteudoValue = conteudoSelect.options[conteudoSelect.selectedIndex]?.value;
        const terminalSelect = document.getElementById('terminalSelect');
        const terminalValue = terminalSelect.options[terminalSelect.selectedIndex]?.value;
        if (conteudoValue=='') {
            alert('Conteúdo obrigatório!');
            return false;
        }
        if (terminalValue=='') {
            alert('Terminal obrigatório!');
            return false;
        }
        const dataInicio = document.getElementById('dataInicio');
        const dataInicioValue = dataInicio.value;
        const dataFim = document.getElementById('dataFim');
        const dataFimValue = dataFim.value;
        if(dataInicioValue==''){
            if(dataFimValue!=''){
                alert('Não pode preencher data final, sem preencher a data inicial!');
                alert('Pode escolher data inical e deixar data final em branco!');
                return false;
            }
        }
        return true;
    }

    // Antes de submeter, coletar os selecionados e criar hidden inputs:
    document.getElementById('btn-salvar').addEventListener('click', function () {
        if (!consisteCampos()) return;
        document.getElementById('frmAgendamento').submit();
        return true;
    });

</script>
</body>
</html>