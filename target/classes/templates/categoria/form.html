<!DOCTYPE html>
<html lang="pt-BR" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${isEdit ? 'Editar Setor' : 'Nova Setor'} + ' - Sistema de Terminais'"></title>
    <link th:href="@{/css/bootstrap.min.css}" rel="stylesheet">
    <link th:href="@{/css/all.min.css}" rel="stylesheet">
    <link th:href="@{/css/style.css}" rel="stylesheet">
    <link rel="icon" type="image/x-icon" th:href="@{/favicon.ico?v=1}" />
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container"><a class="navbar-brand" th:href="@{/home}"><i class="fas fa-desktop"></i> Sistema de
        Terminais Atacadão</a>
        <div class="navbar-nav ms-auto"><a class="nav-link" th:href="@{/logout}"><i class="fas fa-sign-out-alt"></i>
            Sair</a></div>
    </div>
</nav>
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4"><h2><i class="fas fa-tags text-warning"></i><span  class="text-warning"
            th:text="${isEdit ? 'Editar Setor' : 'Novo Setor'}"></span></h2>            <a
            th:href="@{/categorias}" class="btn btn-secondary"> <i class="fas fa-arrow-left"></i> Voltar </a></div>
    <div class="card">
        <div class="card-body">
            <!-- Mensagem de erro -->
            <div th:if="${erro}" class="alert alert-danger" role="alert"
                 th:utext="${#strings.replace(erro, '\n', '<br/>')}">
            </div>
            <form th:action="@{/categorias/salvar}" th:object="${categoriaRequest}" method="post"
                  class="needs-validation" novalidate><input th:if="${isEdit}"
                                                             type="hidden" th:field="*{id}">
                <div class="row">
                    <div class="mb-3 col-md-6">
                        <label for="nome" class="form-label">Nome *</label>
                        <input type="text"
                               class="form-control"
                               th:field="*{nome}"
                               th:classappend="${#fields.hasErrors('nome')} ? 'is-invalid' : ''"
                               placeholder="Ex: Acougue, Padaria, Laticinio, Hortifruti"
                               required maxlength="50" size="15"
                               pattern="^[a-zA-Z\s]+$">
                        <div class="invalid-feedback" th:if="${#fields.hasErrors('nome')}" th:errors="*{nome}"></div>
                        <div class="invalid-feedback" th:unless="${#fields.hasErrors('nome')}">Nome é obrigatório e deve
                            conter apenas letras sem acento e espaços
                        </div>
                        <div class="form-text">Apenas letras sem acento e espaços são permitidos</div>
                    </div>
                    <div class="mb-3 col-md-6">
                        <label for="nome" class="form-label">Nome exibição *</label>
                        <input type="text"
                               class="form-control"
                               th:field="*{nomeExibicao}"
                               th:classappend="${#fields.hasErrors('nomeExibicao')} ? 'is-invalid' : ''"
                               placeholder="Ex: Açougue, Padaria Central, Laticínio, Hortifruti"
                               required maxlength="50"
                               pattern="^[a-zA-ZÀ-ÿ0-9\s]+$">
                        <div class="invalid-feedback" th:if="${#fields.hasErrors('nomeExibicao')}" th:errors="*{nomeExibicao}"></div>
                        <div class="invalid-feedback" th:unless="${#fields.hasErrors('nomeExibicao')}">Nome exibição é obrigatório</div>
                        <div class="form-text">Apenas letras, números, acento e espaços são permitidos</div>
                    </div>
                </div>
                <div class="mb-3"><label for="descricao" class="form-label">Descrição</label> <textarea
                        class="form-control" rows="1" th:field="*{descricao}"
                        th:classappend="${#fields.hasErrors('descricao')} ? 'is-invalid' : ''"
                        placeholder="Descrição detalhada da categoria" maxlength="255"></textarea>
                    <div class="invalid-feedback" th:if="${#fields.hasErrors('descricao')}"
                         th:errors="*{descricao}"></div>
                    <div class="form-text">Máximo 100 caracteres</div>
                </div>

                <!-- Área de seleção de produtos com checkboxes -->
                <div id="area-produtos" class="card mt-4">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-5">
                                <h5>Produtos</h5>
                                <div id="lista-produtos" class="border p-2" style="height: 200px; overflow-y: auto;">
                                    <!-- Checkboxes serão adicionados via JS -->
                                </div>
                            </div>

                            <!-- COLUNA DE CONTROLES -->
                            <div class="col-md-2 control-buttons">
                                <!-- Botões em massa -->
                                <h5>Ações</h5>
                                <div class="bulk-buttons">
                                    <button type="button" id="btn-add-all" class="btn btn-success btn-sm" title="Adicionar todos os produtos">
                                        <i class="fas fa-angle-double-right"></i> Todos
                                    </button><p></p>
                                    <button type="button" id="btn-remove-all" class="btn btn-warning btn-sm" title="Remover todos os produtos">
                                        <i class="fas fa-angle-double-left"></i> Todos
                                    </button><p></p>
                                </div>

                                <!-- Separador visual -->
                                <div class="separator"></div>

                                <!-- Botões individuais -->
                                <div class="individual-buttons">
                                    <button type="button" id="btn-add" class="btn btn-primary" title="Adicionar selecionados">
                                        <i class="fas fa-angle-right"></i>
                                    </button><p></p><p></p>
                                    <button type="button" id="btn-remove" class="btn btn-secondary" title="Remover selecionados">
                                        <i class="fas fa-angle-left"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-5">
                                <h5>Selecionados</h5>
                                <div id="lista-selecionados" class="border p-2" style="height: 250px; overflow-y: auto;">
                                    <!-- Checkboxes selecionados aparecerão aqui -->
                                </div>
                            </div>
                        </div>
                        <!-- Informações úteis -->
                        <div class="row mt-2">
                            <div class="col-12">
                                <small class="text-muted">
                                    <i class="fas fa-info-circle"></i>
                                    Use os botões individuais para mover itens selecionados ou os botões "Todos" para mover todos de uma vez.
                                </small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Campo hidden para enviar produtos selecionados -->
                <input type="hidden" th:field="*{produtosSelecionados}" id="produtosSelecionados">

                <div class="d-grid gap-2 d-md-flex justify-content-md-end"><a th:href="@{/categorias}"
                                                                              class="btn btn-secondary me-md-2">Cancelar</a>
                    <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> <span
                            th:text="${isEdit ? 'Atualizar' : 'Salvar'}"></span></button>
                </div>
            </form>
        </div>
    </div>
</div>
<script>
    const produtosSelecionadosHidden = document.getElementById('produtosSelecionados');

    function atualizarProdutosSelecionados() {
        const selecionados = document.getElementById('lista-selecionados');
        const ids = Array.from(selecionados.querySelectorAll('input[type=checkbox]'))
            .map(input => input.value);
        produtosSelecionadosHidden.value = ids.join(',');
        // Atualizar estado dos botões
        atualizarEstadoBotoes();
    }
    // Atualizar estado dos botões baseado no conteúdo das listas
    function atualizarEstadoBotoes() {
        const listaProdutos = document.getElementById('lista-produtos');
        const listaSelecionados = document.getElementById('lista-selecionados');

        const btnAddAll = document.getElementById('btn-add-all');
        const btnRemoveAll = document.getElementById('btn-remove-all');
        const btnAdd = document.getElementById('btn-add');
        const btnRemove = document.getElementById('btn-remove');

        // Verificar se há produtos disponíveis
        const temProdutosDisponiveis = listaProdutos.children.length > 0;
        const temProdutosSelecionados = listaSelecionados.children.length > 0;

        // Verificar se há itens marcados
        const temProdutosMarcadosDisponiveis = listaProdutos.querySelectorAll('input[type=checkbox]:checked').length > 0;
        const temProdutosMarcadosSelecionados = listaSelecionados.querySelectorAll('input[type=checkbox]:checked').length > 0;

        // Habilitar/desabilitar botões
        btnAddAll.disabled = !temProdutosDisponiveis;
        btnRemoveAll.disabled = !temProdutosSelecionados;
        btnAdd.disabled = !temProdutosMarcadosDisponiveis;
        btnRemove.disabled = !temProdutosMarcadosSelecionados;

        // Atualizar tooltips dos botões
        btnAddAll.title = temProdutosDisponiveis ?
            `Adicionar todos os ${listaProdutos.children.length} produtos` :
            'Nenhum produto disponível';

        btnRemoveAll.title = temProdutosSelecionados ?
            `Remover todos os ${listaSelecionados.children.length} produtos selecionados` :
            'Nenhum produto selecionado';
    }
    function checarExibirArea() {
        const cat = document.getElementById('id');
        if (cat && cat.value != '') {
            carregarProdutos(cat.value);
        }
    }
    // Carrega produtos via Ajax
    function carregarProdutos(catId) {
        const jaSelecionados = (produtosSelecionadosHidden.value || '')
            .split(',')
            .filter(v => v.trim() !== '');
        $.ajax({
            url:'/api-mercado/api/export/porCategoria/' + catId,
            method: 'GET',
            cache: false,
            dataType: 'json'
        }).done(function (data) {
            const lista = document.getElementById('lista-produtos');
            const listaSel = document.getElementById('lista-selecionados');
            lista.innerHTML = '';
            // Se já existem selecionados (modo edição), monta do lado direito
            if (jaSelecionados.length > 0 && listaSel.children.length === 0) {
                jaSelecionados.forEach(id => {
                    const produto = data.produtos.find(p => p.id == id);
                    if (produto) {
                        const div = criarCheckboxProduto(produto);
                        listaSel.appendChild(div);
                    }
                });
            }
            // Monta a lista da esquerda sem os já selecionados
            data.produtos.forEach(produto => {
                if (!jaSelecionados.includes(produto.id.toString())) {
                    const div = criarCheckboxProduto(produto);
                    lista.appendChild(div);
                }
            });
            // Atualizar estado dos botões após carregar
            atualizarEstadoBotoes();
        });
    }

    function criarCheckboxProduto(produto) {
        const div = document.createElement('div');
        div.classList.add('form-check');

        const input = document.createElement('input');
        input.type = 'checkbox';
        input.classList.add('form-check-input');
        input.value = produto.id;
        input.id = 'produto-' + produto.id;

        // Adicionar event listener para atualizar botões quando marcar/desmarcar
        input.addEventListener('change', atualizarEstadoBotoes);

        const label = document.createElement('label');
        label.classList.add('form-check-label');
        label.htmlFor = input.id;
        label.textContent = formatarLinha(produto.cdTxtimport, produto.nome, produto.preco);

        div.appendChild(input);
        div.appendChild(label);
        return div;
    }

    function formatarLinha(codigo, nome, preco) {
        const codigoFormatado = String(codigo).padStart(5, '0');
        let nomeFormatado = String(nome || '').substring(0, 50);
        nomeFormatado = nomeFormatado.padEnd(50, ' ');

        const precoFormatado = new Intl.NumberFormat('pt-BR', {
            style: 'currency',
            currency: 'BRL'
        }).format(Number(preco) || 0);

        // Alinha à direita com largura especificada
        const precoAlinhado = precoFormatado.padStart(15, ' ');

        return `${codigoFormatado} - ${nomeFormatado}->${precoAlinhado}`;
    }
    document.addEventListener('DOMContentLoaded', () => {
        checarExibirArea();
    });

    // Mover itens entre listas
    document.getElementById('btn-add').addEventListener('click', () => {
        moverItens('lista-produtos', 'lista-selecionados');
    });
    document.getElementById('btn-remove').addEventListener('click', () => {
        moverItens('lista-selecionados', 'lista-produtos');
    });

    // Adicionar todos e Remover todos
    document.getElementById('btn-add-all').addEventListener('click', () => {
        moverTodosItens('lista-produtos', 'lista-selecionados');
    });

    document.getElementById('btn-remove-all').addEventListener('click', () => {
        moverTodosItens('lista-selecionados', 'lista-produtos');
    });

    function moverItens(origemId, destinoId) {
        const origem = document.getElementById(origemId);
        const destino = document.getElementById(destinoId);

        Array.from(origem.querySelectorAll('input[type=checkbox]:checked')).forEach(input => {
            const div = input.parentElement;
            input.checked = false;
            destino.appendChild(div);
        });

        atualizarProdutosSelecionados();
    }
    function moverTodosItens(origemId, destinoId) {
        const origem = document.getElementById(origemId);
        const destino = document.getElementById(destinoId);

        // Confirmar ação se houver muitos itens
        const totalItens = origem.children.length;
        if (totalItens > 10) {
            const nomeOrigem = origemId === 'lista-produtos' ? 'disponíveis' : 'selecionados';
            const nomeDestino = origemId === 'lista-produtos' ? 'selecionados' : 'disponíveis';

            if (!confirm(`Tem certeza que deseja mover todos os ${totalItens} produtos ${nomeOrigem} para ${nomeDestino}?`)) {
                return;
            }
        }

        // Mover todos os itens
        Array.from(origem.children).forEach(div => {
            const input = div.querySelector('input[type=checkbox]');
            if (input) {
                input.checked = false; // Desmarcar checkbox
            }
            destino.appendChild(div);
        });

        // Atualizar produtos selecionados e estado dos botões
        atualizarProdutosSelecionados();

        // Feedback visual
        const action = origemId === 'lista-produtos' ? 'adicionados' : 'removidos';
        console.log(`${totalItens} produtos ${action} com sucesso!`);
    }

    document.querySelector('form').addEventListener('submit', function(e) {
        atualizarProdutosSelecionados();
    });
</script>
<script th:src="@{/js/bootstrap.bundle.min.js}"></script>
<script th:src="@{/js/jquery-3.7.1.min.js}"></script>
<script th:src="@{/js/app.js}"></script>
</body>
</html>